# 1. 第一节
## 1.1. 问题
计算机如何读懂四则运算表达式？
`"9.3 + (3 - -0.11) * 5"`

## 1.2. 后缀表达式
- 人类习惯的数学表达式叫做中缀表达式
- 另外，还有一种将运算符放在数字后面的后缀表达式
- 实例：
```
5 + 3 -> 5 3 +
1 + 2 * 3 -> 1 2 3 * +
9 + (3 - 1) * 5 -> 9 3 1 - 5 * +
```

## 1.3. 中缀or后缀
- 中缀表达式符合人类的阅读和思维习惯
- 后缀表达式符合计算机的运算方式
    - 消除了中缀表达式中的括号
    - 同时保留中缀表达式中的运算优先级

## 1.4. 计算器核心算法
- 解决方案
    1. 将中缀表达式进行数字和运算符的分离
    2. 将中缀表达式转换为后缀表达式
    3. 通过后缀表达式计算最终结果

## 1.5. 分离算法分析
- 所要计算的中缀表达式中包含
    - 数字和小数点【0 - 9 或 .】
    - 符号位【+ 或 -】
    - 运算符【+, -, *, /】
    - 括号【( 或 )】
    > `9.3 + (3 - -0.11) * 5`

- 思想：以符号作为标志对表达式中的字符逐个访问
    - 定义累计变量 num
    - 当前字符 exp[i] 为数字或小数点时
        - 累计：num += exp[i]
    - 当前字符 exp[i] 为符号时
        - num为运算数，分离并保存
        - 若 exp[i] 为正负号：
            - √累计符号位 + 和 - ：num += exp[i]
        - 若 exp[i] 为运算符：
            - √分离并保存

```c
for (int i = 0; i < exp_length(); i++) {
    if (exp[i]为数字或小数点)
        累计：num += exp[i];
    else if (exp[i]为符号) {
        if (num != "") {
            分离并保存运算数：num;
        }

        if (exp[i]为正号或负号) {
            符号位累计：num += exp[i];
        } else {
            分离并保存运算符：exp[i];
        }
    }
}
```

- 难点：
    - 如何区分正负号与加号和减号?
        - `+`和`-`在表达式的第一个位置
        - 括号后的`+`和`-`
        - 运算符后的`+`和`-`
        > `+9 + (-3 - -1) * -5`

## 1.6. 编程实验 表达式分离算法Calculator.pro

## 1.7. 小结
- QString中的每个字符为QChar
- Qt中提供了开发中不可或缺的数据结构类
- 四则运算表达式的计算分三个步骤
    - 数字和符号分离
    - 中缀表达式转后缀表达式
    - 根据后缀表达式计算结果

# 2. 第二节
## 2.1. 中缀转后缀
- 中缀表达式转后缀表达式的过程类似编译过程
    - 四则运算表达式中的括号必须匹配
    - 根据运算符优先级进行转换
    - 转换后的表达式中没有括号
    - 转换后可以顺序的计算出最终结果

- 转换过程：
    - 当前元素e为数字：输出
    - 当前元素e为运算符：
        1. 与栈顶运算符进行优先级比较
        2. 小于等于：将栈顶元素输出，转1
        3. 大于：将当前元素e入栈
    - 当前元素e为左括号：入栈
    - 当前元素e为右括号：
        1. 弹出栈顶元素并输出，直至栈顶元素为左括号
        2. 将栈顶的左括号从栈中弹出

```c
while (!exp.isEmpty()) {
    QString e = exp.dequeue();

    if (isNumber(e)) {
        输出 : e;
    } else if (isOperator(e)) {
        while (priority(e) <= priority(stack.top()))
            输出栈顶元素, stack.pop();
        stack.push(e);
    } else if (isLeft(e)) {
        stack.push(e);
    } else if (isRight(e)) {
        while (!isLeft(stack.top())) {
            输出栈顶元素, stack.pop();
        }
        从栈中弹出左后号 : stack.pop();
    }
}
```

- 关键点：转换过程中左右括号是重要标志
    - 如何确保表达式中的括号能够左右匹配？

## 2.2. 括号匹配算法
- 合法的四则运算表达式中
    - 括号匹配成对出现
    - 左括号必然先于右括号出现

```c
for (int i = 0; i < len; i++) {
    if (exp[i]为左括号) {
        exp[i]入栈;
    } else if (exp[i]为右括号) {
        if (栈顶元素为左括号) {
            将栈顶元素弹出;
        } else {
            匹配错误;
        }
    }
}
```

## 2.3. 编程实验 中缀表达式转后缀表达式 Calculator.pro

## 2.4. 小结
- 后缀表达式是程序计算复杂表达式的基础
- 中缀到后缀的转换是基于栈数据结构的
- 转换过程能够发现表达式中的语法错误

# 3. 第三节
## 3.1. 后缀表达式计算
- 遍历后缀表达式中的数字和运算符
    - 当前元素为数字：进栈
    - 当前元素为运算符：
    1. 从栈中弹出右操作数
    2. 从栈中弹出左操作数
    3. 根据符号进行运算
    4. 将运算结果压入栈中

- 遍历结束
    - 栈中的唯一数字为运算结果

```c
while (!exp.isEmpty()) {
    if (当前元素为数字) {
        入栈;
    } else if (当前元素为运算符) {
        1. 从栈中弹出右操作数;
        2. 从栈中弹出旬累作数;
        3. 根据符号进行运算;
        4. 将运卓吉果压入栈中;
    }
    else
        表达式错误;
}
```

- 注意
    - 与数学计算相关的算法都需要考虑除0的情况
    - 若是浮点运算，避免代码中直接与0做相等比较

```c
const double P = 0.000000000000001;

if ((-P < r) && (r < P)) {
    ret = "Error";
} else {
    ret.sprintf("%f", l / r);
}
```

## 3.2. 编程实验 计算后缀表达式Calculator.pro

## 3.3. 小结
- 计算方法由3个不同的子算法构成
- Qt项目在整体上采用面向对象分析与设计
- 局部的算法设计依旧采用面向过程的方法完成
- Qt开发是各种开发技术的综合运用
